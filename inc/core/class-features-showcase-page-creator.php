<?php
/**
 * åŠŸèƒ½æ¸…å•å±•ç¤ºé¡µé¢åˆ›å»ºå™¨ç±»
 *
 * å½“ç”¨æˆ·é€‰æ‹©"åŠŸèƒ½æ¸…å•å±•ç¤º"æ¨¡æ¿åˆ›å»ºé¡µé¢æ—¶ï¼Œè‡ªåŠ¨å¡«å……é¢„è®¾æ¨¡å—å†…å®¹
 *
 * @package Developer_Starter
 * @since 1.0.0
 */

namespace Developer_Starter\Core;

// é˜²æ­¢ç›´æŽ¥è®¿é—®
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * åŠŸèƒ½æ¸…å•å±•ç¤ºé¡µé¢åˆ›å»ºå™¨ç±»
 */
class Features_Showcase_Page_Creator {

    /**
     * æž„é€ å‡½æ•°
     */
    public function __construct() {
        // ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§ç¡®ä¿åœ¨ meta-boxes ä¿å­˜ä¹‹åŽæ‰§è¡Œ
        add_action( 'save_post', array( $this, 'on_page_save' ), 99, 2 );
        
        // æ·»åŠ  AJAX é’©å­ç”¨äºŽæ‰‹åŠ¨å¡«å……æ¨¡å—
        add_action( 'wp_ajax_fill_features_showcase_modules', array( $this, 'ajax_fill_modules' ) );
    }

    /**
     * é¡µé¢ä¿å­˜æ—¶çš„å›žè°ƒ
     *
     * @param int     $post_id é¡µé¢ID
     * @param WP_Post $post    é¡µé¢å¯¹è±¡
     */
    public function on_page_save( $post_id, $post ) {
        // åªå¤„ç†é¡µé¢ç±»åž‹
        if ( $post->post_type !== 'page' ) {
            return;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªåŠ¨ä¿å­˜
        if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
            return;
        }

        // æ£€æŸ¥æƒé™
        if ( ! current_user_can( 'edit_post', $post_id ) ) {
            return;
        }

        // èŽ·å–é¡µé¢æ¨¡æ¿
        $template = get_post_meta( $post_id, '_wp_page_template', true );

        // åªå¤„ç†åŠŸèƒ½æ¸…å•å±•ç¤ºæ¨¡æ¿
        if ( $template !== 'templates/template-features-showcase.php' ) {
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¨¡å—é…ç½®
        $modules = get_post_meta( $post_id, '_developer_starter_modules', true );
        
        // æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°ä¸ºå·²å¡«å……ï¼ˆé¿å…é‡å¤å¡«å……ï¼‰
        $filled = get_post_meta( $post_id, '_features_showcase_modules_filled', true );
        
        // å¦‚æžœæ²¡æœ‰æ¨¡å—ï¼ˆç©ºæ•°ç»„æˆ–ç©ºå€¼ï¼‰ä¸”å°šæœªå¡«å……è¿‡ï¼Œè®¾ç½®é»˜è®¤æ¨¡å—
        if ( ( empty( $modules ) || ! is_array( $modules ) || count( $modules ) === 0 ) && ! $filled ) {
            $this->set_default_modules( $post_id );
            // æ ‡è®°ä¸ºå·²å¡«å……ï¼Œé˜²æ­¢åŽç»­å†æ¬¡è¦†ç›–
            update_post_meta( $post_id, '_features_showcase_modules_filled', '1' );
        }
    }

    /**
     * AJAX æ‰‹åŠ¨å¡«å……æ¨¡å—
     */
    public function ajax_fill_modules() {
        check_ajax_referer( 'fill_features_showcase_modules', 'nonce' );
        
        $post_id = isset( $_POST['post_id'] ) ? intval( $_POST['post_id'] ) : 0;
        
        if ( ! $post_id || ! current_user_can( 'edit_post', $post_id ) ) {
            wp_send_json_error( array( 'message' => 'æƒé™ä¸è¶³' ) );
        }
        
        $this->set_default_modules( $post_id );
        update_post_meta( $post_id, '_features_showcase_modules_filled', '1' );
        
        wp_send_json_success( array( 'message' => 'æ¨¡å—å·²å¡«å……ï¼Œè¯·åˆ·æ–°é¡µé¢' ) );
    }

    /**
     * è®¾ç½®åŠŸèƒ½æ¸…å•å±•ç¤ºé¡µé¢çš„é»˜è®¤æ¨¡å—
     *
     * @param int $page_id é¡µé¢ID
     */
    public function set_default_modules( $page_id ) {
        $default_modules = array(
            // æ¨¡å—1ï¼šåŠŸèƒ½æ¸…å•åˆ—è¡¨ - æ ¸å¿ƒæ¨¡å—
            array(
                'type' => 'features_list',
                'data' => array(
                    'title'    => 'å¼ºå¤§çš„åŠŸèƒ½ç‰¹æ€§',
                    'subtitle' => '22+ å†…ç½®æ¨¡å—ï¼Œè¦†ç›–ä¼ä¸šç½‘ç«™å»ºè®¾çš„å„ä¸ªæ–¹é¢',
                    'bg_color' => '',
                    'columns'  => '3',
                    'tabs'     => array(
                        // Tab 1ï¼šé¡µé¢æ¨¡å—ç³»ç»Ÿ
                        array(
                            'tab_id'    => 'modules',
                            'tab_title' => 'é¡µé¢æ¨¡å—',
                            'tab_icon'  => 'ðŸ“¦',
                            'features'  => "ðŸŽ¯|æ¨ªå¹…æ¨¡å—|æ”¯æŒè½®æ’­ã€è§†é¢‘èƒŒæ™¯çš„Bannerå±•ç¤ºï¼Œå¤šç§åŠ¨ç”»æ•ˆæžœå¯é€‰\nðŸ“¦|äº§å“ä¸­å¿ƒ|åˆ†ç±»å±•ç¤ºäº§å“ï¼Œè‡ªåŠ¨èŽ·å–å°é¢å›¾ï¼Œå¤šç§å¸ƒå±€é£Žæ ¼\nðŸ’¼|æˆåŠŸæ¡ˆä¾‹|å®¢æˆ·æ¡ˆä¾‹å±•ç¤ºï¼Œæ”¯æŒå¤šç§å¡ç‰‡é£Žæ ¼åˆ‡æ¢\nðŸ“°|æ–°é—»åŠ¨æ€|è‡ªåŠ¨èŽ·å–æ–‡ç« åˆ—è¡¨ï¼Œå¤šå¸ƒå±€å±•ç¤ºæ–°é—»èµ„è®¯\nðŸ’°|ä»·æ ¼å¥—é¤|å¯å®šåˆ¶çš„å®šä»·è¡¨æ¨¡å—ï¼Œæ”¯æŒæ¸å˜è‰²å’Œç‰¹æ€§åˆ—è¡¨\nðŸ“‹|åŠŸèƒ½æ¸…å•|Tabåˆ‡æ¢çš„åŠŸèƒ½å¡ç‰‡å±•ç¤ºï¼ŒçŽ°ä»£åŒ–è®¾è®¡\nðŸ”„|æµç¨‹å±•ç¤º|æ—¶é—´çº¿/æ­¥éª¤å¼æµç¨‹å±•ç¤ºï¼Œå¤šç§æ ·å¼å¯é€‰\nðŸŽ¥|è§†é¢‘æ¨¡å—|æ”¯æŒæœ¬åœ°è§†é¢‘å’ŒBç«™è§†é¢‘åµŒå…¥æ’­æ”¾\nðŸ’¬|å®¢æˆ·è¯„ä»·|å¤šç§æ ·å¼çš„å®¢æˆ·è§è¯æ¨¡å—ï¼Œå¢žå¼ºå¯ä¿¡åº¦",
                        ),
                        // Tab 2ï¼šç”¨æˆ·ç³»ç»Ÿ
                        array(
                            'tab_id'    => 'user',
                            'tab_title' => 'ç”¨æˆ·ç³»ç»Ÿ',
                            'tab_icon'  => 'ðŸ‘¤',
                            'features'  => "ðŸ”|ç™»å½•æ³¨å†Œ|å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒé‚®ç®±éªŒè¯\nðŸ‘¤|ä¼šå‘˜ä¸­å¿ƒ|ä¸ªäººèµ„æ–™ç®¡ç†ï¼Œå¤´åƒä¸Šä¼ ï¼Œå¯†ç ä¿®æ”¹\nðŸ”‘|å¯†ç æ‰¾å›ž|é‚®ä»¶éªŒè¯é‡ç½®å¯†ç ï¼Œå®‰å…¨å¯é \nðŸ“§|é‚®ä»¶ç³»ç»Ÿ|SMTPé‚®ä»¶å‘é€æ”¯æŒï¼ŒåŠ å¯†å­˜å‚¨å‡­è¯\nðŸ›¡ï¸|è¡¨å•éªŒè¯|å‰åŽç«¯åŒé‡éªŒè¯ï¼Œé˜²æ­¢æ¶æ„æäº¤\nâ±ï¸|é¢‘çŽ‡é™åˆ¶|é˜²æ­¢æš´åŠ›ç ´è§£ï¼Œä¿æŠ¤ç”¨æˆ·è´¦æˆ·å®‰å…¨",
                        ),
                        // Tab 3ï¼šä¸ªæ€§åŒ–å®šåˆ¶
                        array(
                            'tab_id'    => 'customize',
                            'tab_title' => 'ä¸ªæ€§åŒ–å®šåˆ¶',
                            'tab_icon'  => 'ðŸŽ¨',
                            'features'  => "ðŸŽ¨|ä¸»é¢˜è‰²å®šåˆ¶|ä¸€é”®åˆ‡æ¢ä¸»é¢˜è‰²ï¼Œæ”¯æŒæ¸å˜è‰²é…ç½®\nðŸŒ™|æš—é»‘æ¨¡å¼|å®Œæ•´çš„æ·±è‰²ä¸»é¢˜æ”¯æŒï¼Œè‡ªåŠ¨é€‚é…æ‰€æœ‰æ¨¡å—\nðŸ“±|æ‚¬æµ®å·¥å…·æ |å¯å®šåˆ¶çš„æ‚¬æµ®æŒ‰é’®ï¼Œè”ç³»æ–¹å¼å¿«æ·å…¥å£\nðŸ“¢|å…¬å‘Šç³»ç»Ÿ|å¤šç±»åž‹å…¬å‘Šå±•ç¤ºï¼Œæ–‡å­—/å›¾æ–‡/å¼¹çª—æ¨¡å¼\nðŸ–¼ï¸|Logoå®šåˆ¶|æ”¯æŒæ™®é€š/æš—è‰²æ¨¡å¼åŒLogoé…ç½®\nðŸ“|é¡µè„šé…ç½®|å¤šæ é¡µè„šå¸ƒå±€ï¼Œç¤¾äº¤åª’ä½“å›¾æ ‡ï¼ŒåŠ¨ç”»æ•ˆæžœ",
                        ),
                        // Tab 4ï¼šæ€§èƒ½ä¸Žå®‰å…¨
                        array(
                            'tab_id'    => 'performance',
                            'tab_title' => 'æ€§èƒ½ä¸Žå®‰å…¨',
                            'tab_icon'  => 'âš¡',
                            'features'  => "âš¡|æ€§èƒ½ä¼˜åŒ–|å›¾ç‰‡æ‡’åŠ è½½ï¼Œèµ„æºæŒ‰éœ€åŠ è½½ï¼Œæžé€Ÿä½“éªŒ\nðŸ›¡ï¸|å®‰å…¨é˜²æŠ¤|XSSé˜²æŠ¤ï¼Œæ•°æ®è½¬ä¹‰ï¼Œå®‰å…¨è¾“å‡º\nðŸ“Š|åŽå°ç®¡ç†|ç®€æ´ç›´è§‚çš„è®¾ç½®é¢æ¿ï¼Œåˆ†ç»„é…ç½®é¡¹\nðŸ”§|æ¨¡å—ç®¡ç†|æ‹–æ‹½å¯è§†åŒ–é…ç½®ï¼Œå®žæ—¶é¢„è§ˆæ•ˆæžœ\nðŸ“±|å“åº”å¼è®¾è®¡|å®Œç¾Žé€‚é…å„ç§å±å¹•å°ºå¯¸ï¼Œç§»åŠ¨ç«¯ä¼˜åŒ–\nðŸ”|SEOä¼˜åŒ–|è¯­ä¹‰åŒ–æ ‡ç­¾ï¼Œç»“æž„åŒ–æ•°æ®ï¼Œæœç´¢å¼•æ“Žå‹å¥½",
                        ),
                    ),
                ),
            ),

            // æ¨¡å—2ï¼šæ•°æ®ç»Ÿè®¡
            array(
                'type' => 'stats',
                'data' => array(
                    'stats_bg_image'   => '',
                    'stats_text_align' => 'center',
                    'stats_items'      => array(
                        array( 'number' => '22', 'label' => 'å†…ç½®æ¨¡å—' ),
                        array( 'number' => '50', 'label' => 'åŠŸèƒ½ç‰¹æ€§' ),
                        array( 'number' => '100', 'label' => 'å“åº”å¼' ),
                        array( 'number' => '0', 'label' => 'ä»£ç è¦æ±‚' ),
                    ),
                ),
            ),

            // æ¨¡å—3ï¼šå¤šå›¾æ–‡æ¨¡å— - æ›´å¤šäº®ç‚¹
            array(
                'type' => 'multi_image_text',
                'data' => array(
                    'multi_image_text_title'    => 'æ›´å¤šäº®ç‚¹',
                    'multi_image_text_subtitle' => 'ç²¾å¿ƒè®¾è®¡çš„ç»†èŠ‚ï¼Œè®©æ‚¨çš„ç½‘ç«™ä¸Žä¼—ä¸åŒ',
                    'multi_image_text_layout'   => 'left',
                    'multi_image_text_items'    => array(
                        array(
                            'icon'  => 'ðŸ“¦',
                            'title' => 'æ¨¡å—åŒ–æž¶æž„',
                            'desc'  => 'é‡‡ç”¨é¢å‘å¯¹è±¡çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œä»£ç ç»“æž„æ¸…æ™°ï¼Œæ˜“äºŽæ‰©å±•å’Œç»´æŠ¤ã€‚æ¯ä¸ªæ¨¡å—ç‹¬ç«‹è¿ä½œï¼Œäº’ä¸å¹²æ‰°ã€‚',
                            'image' => '',
                            'link'  => '',
                        ),
                        array(
                            'icon'  => 'ðŸŽ¨',
                            'title' => 'å¯è§†åŒ–é…ç½®',
                            'desc'  => 'åŽå°æ‹–æ‹½å¼æ¨¡å—é…ç½®ï¼Œæ‰€è§å³æ‰€å¾—ã€‚æ— éœ€ç¼–å†™ä»£ç ï¼Œè½»æ¾æž„å»ºä¸“ä¸šé¡µé¢ã€‚',
                            'image' => '',
                            'link'  => '',
                        ),
                        array(
                            'icon'  => 'ðŸ›¡ï¸',
                            'title' => 'å®‰å…¨å¯é ',
                            'desc'  => 'éµå¾ªWordPresså®‰å…¨æœ€ä½³å®žè·µï¼Œæ•°æ®è½¬ä¹‰ã€æƒé™éªŒè¯ã€CSRFä¿æŠ¤ï¼Œè®©æ‚¨é«˜æž•æ— å¿§ã€‚',
                            'image' => '',
                            'link'  => '',
                        ),
                    ),
                ),
            ),

            // æ¨¡å—4ï¼šå¸¸è§é—®é¢˜
            array(
                'type' => 'faq',
                'data' => array(
                    'faq_title' => 'å¸¸è§é—®é¢˜',
                    'faq_items' => array(
                        array(
                            'question' => 'å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰æ¨¡å—åˆ°é¡µé¢ï¼Ÿ',
                            'answer'   => 'åœ¨åŽå°ç¼–è¾‘é¡µé¢æ—¶ï¼Œæ‰¾åˆ°ã€Œé¡µé¢æ¨¡å—é…ç½®ã€åŒºåŸŸï¼Œç‚¹å‡»ã€Œæ·»åŠ æ¨¡å—ã€æŒ‰é’®é€‰æ‹©éœ€è¦çš„æ¨¡å—ç±»åž‹ï¼Œç„¶åŽå¡«å†™æ¨¡å—å†…å®¹å³å¯ã€‚æ”¯æŒæ‹–æ‹½æŽ’åºå’Œå®žæ—¶é¢„è§ˆã€‚',
                        ),
                        array(
                            'question' => 'ä¸»é¢˜æ”¯æŒå“ªäº›é¡µé¢æ¨¡æ¿ï¼Ÿ',
                            'answer'   => 'ä¸»é¢˜å†…ç½®å¤šç§é¡µé¢æ¨¡æ¿ï¼šæ¨¡å—åŒ–é¦–é¡µã€å…³äºŽæˆ‘ä»¬ã€äº§å“ä¸­å¿ƒã€æˆåŠŸæ¡ˆä¾‹ã€æ–°é—»åŠ¨æ€ã€è§£å†³æ–¹æ¡ˆã€è½åœ°é¡µã€åŠŸèƒ½æ¸…å•å±•ç¤ºã€å¸¸è§é—®é¢˜ã€è”ç³»æˆ‘ä»¬ç­‰ï¼Œæ»¡è¶³ä¼ä¸šç½‘ç«™çš„å„ç§éœ€æ±‚ã€‚',
                        ),
                        array(
                            'question' => 'å¦‚ä½•è‡ªå®šä¹‰ä¸»é¢˜è‰²ï¼Ÿ',
                            'answer'   => 'è¿›å…¥ã€Œå¤–è§‚ã€â†’ã€Œä¸»é¢˜è®¾ç½®ã€ï¼Œåœ¨ã€ŒåŸºç¡€è®¾ç½®ã€é€‰é¡¹å¡ä¸­å¯ä»¥é…ç½®ä¸»é¢˜ä¸»è‰²è°ƒã€è¾…åŠ©è‰²ç­‰ï¼Œæ”¯æŒé¢œè‰²é€‰æ‹©å™¨å’Œæ¸å˜è‰²é…ç½®ï¼Œä¿®æ”¹åŽå…¨ç«™è‡ªåŠ¨åº”ç”¨ã€‚',
                        ),
                        array(
                            'question' => 'ä¸»é¢˜å¯¹SEOä¼˜åŒ–æœ‰å¸®åŠ©å—ï¼Ÿ',
                            'answer'   => 'æ˜¯çš„ï¼Œä¸»é¢˜é‡‡ç”¨è¯­ä¹‰åŒ–HTML5æ ‡ç­¾ã€åˆç†çš„æ ‡é¢˜å±‚çº§ç»“æž„ã€å›¾ç‰‡æ‡’åŠ è½½ä¼˜åŒ–ã€å¿«é€ŸåŠ è½½æ€§èƒ½ç­‰ï¼Œéƒ½æœ‰åŠ©äºŽæœç´¢å¼•æ“Žä¼˜åŒ–ã€‚å»ºè®®é…åˆä¸“ä¸šSEOæ’ä»¶ä½¿ç”¨æ•ˆæžœæ›´ä½³ã€‚',
                        ),
                    ),
                ),
            ),

            // æ¨¡å—5ï¼šCTAè¡ŒåŠ¨å¬å”¤
            array(
                'type' => 'cta',
                'data' => array(
                    'cta_title'       => 'å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿ',
                    'cta_subtitle'    => 'ç«‹å³ä½“éªŒåŠŸèƒ½å¼ºå¤§çš„ä¼ä¸šçº§WordPressä¸»é¢˜',
                    'cta_button_text' => 'è”ç³»æˆ‘ä»¬',
                    'cta_button_url'  => '/contact/',
                ),
            ),
        );

        update_post_meta( $page_id, '_developer_starter_modules', $default_modules );
    }
}
